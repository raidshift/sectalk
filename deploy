#!/bin/bash

if [ $# -ne 2 ]; then
    echo "Usage: $0 <user> <server>"
    echo "Example: $0 john 192.168.1.100"
    exit 1
fi

USER="$1"
SERVER="$2"

TARGET_WEB_CLIENT="/var/www/sectalk.my.to/html/"
TARGET_SERVER="~/"

# Test SSH connection 
echo "Testing SSH connection to $USER@$SERVER ..."
if ! ssh -o ConnectTimeout=10 -o BatchMode=yes "$USER@$SERVER" "echo '✓ OK'"; then
    echo "✗ Failed to connect to $USER@$SERVER"
    exit 1
fi

# Build Web client
echo "Building Web client ..."
if ! npm run build; then
    echo "✗ npm run build failed"
    exit 1
fi

echo "✓ OK"

# Build service
echo "Building service ..."
if ! cargo build --release; then
    echo "✗ cargo build --release failed"
    exit 1
fi

echo "✓ OK"

# Deploy Web client
echo "Deploying Web client ..."
if ! scp dist/index.html "$USER@$SERVER:$TARGET_WEB_CLIENT"; then
    echo "✗ Failed to deploy dist/index.html"
    exit 1
fi

echo "✓ OK"

# stop service
echo "Stopping service ..."
if ! ssh "$USER@$SERVER" "sudo systemctl stop sectalkd"; then
    echo "✗ Failed to stop sectalkd service"
    exit 1
fi

echo "✓ OK"

# Deploy service
echo "Deploying service ..."
if ! scp target/release/sectalkd "$USER@$SERVER:$TARGET_SERVER"; then
    echo "✗ Failed to deploy target/release/sectalkd"
    exit 1
fi

echo "✓ OK"

# Start service
echo "Starting sectalkd service ..."
if ! ssh "$USER@$SERVER" "
    sudo systemctl daemon-reload &&
    sudo systemctl start sectalkd &&
    sudo systemctl is-active --quiet sectalkd
"; then
    echo "✗ Failed to start sectalkd service"
    exit 1
fi

echo "✓ OK"
exit 0